# Shared Gateway Resource
# Deployed automatically by ArgoCD when envoyGateway.enabled=true
#
# This is the cluster-wide gateway that all applications reference via HTTPRoutes.
# Benefits:
# - Single LoadBalancer IP (cost-effective)
# - Zero-downtime client onboarding (just add HTTPRoute)
# - Clean namespace isolation
# - Flexible hostname management

---
# Gateway System Namespace
# Created by Envoy Gateway operator, but declaring here for clarity
apiVersion: v1
kind: Namespace
metadata:
  name: gateway-system
  labels:
    app.kubernetes.io/name: gateway-system
    app.kubernetes.io/component: infrastructure
    app.kubernetes.io/managed-by: argocd

---
# Shared Gateway Resource
# All applications reference this gateway via HTTPRoutes
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: shared-gateway
  namespace: gateway-system
  labels:
    app.kubernetes.io/name: shared-gateway
    app.kubernetes.io/component: gateway
    app.kubernetes.io/managed-by: argocd
  annotations:
    # Cert-manager will automatically provision certificates via HTTP-01
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  # Use Envoy Gateway implementation
  gatewayClassName: envoy-gateway
  
  # Gateway listeners
  listeners:
    # HTTPS listener - accepts all traffic on port 443
    - name: https
      port: 443
      protocol: HTTPS
      hostname: "*.mycureapp.com"  # Accept all mycureapp.com subdomains
      
      # Allow HTTPRoutes from any namespace
      allowedRoutes:
        namespaces:
          from: All  # Critical for multi-tenant architecture
      
      # TLS termination
      tls:
        mode: Terminate
        certificateRefs:
          # Certificate managed by cert-manager
          - name: gateway-tls
            kind: Secret
    
    # Optional: HTTP listener for redirect to HTTPS
    - name: http
      port: 80
      protocol: HTTP
      hostname: "*.mycureapp.com"  # Accept all mycureapp.com subdomains
      allowedRoutes:
        namespaces:
          from: All
