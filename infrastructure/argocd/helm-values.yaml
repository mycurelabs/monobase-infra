# ArgoCD - Helm Values
# Chart: https://github.com/argoproj/argo-helm
# Version: 5.x+

# Global settings
global:
  domain: argocd.example.com  # Set in client config

# High Availability mode
redis-ha:
  enabled: true
  haproxy:
    enabled: true
    replicas: 3

# Controller (reconciliation engine)
controller:
  replicas: 2  # HA

  metrics:
    enabled: true
    serviceMonitor:
      enabled: false  # Enable when monitoring stack is deployed

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2
      memory: 2Gi

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: application-controller
            topologyKey: kubernetes.io/hostname

# Server (API and UI)
server:
  replicas: 2  # HA

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70

  metrics:
    enabled: true
    serviceMonitor:
      enabled: false

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 1Gi

  # Ingress via Gateway API (see ingress.yaml)
  ingress:
    enabled: false

  # Server configuration
  config:
    url: https://argocd.example.com  # Set in client config

    # Git repository credentials
    repositories: |
      - type: git
        url: https://github.com/monobaselabs/monobase-infra.git
      # Add client repositories here

    # Resource customizations
    resource.customizations: |
      argoproj.io/Application:
        health.lua: |
          hs = {}
          hs.status = "Progressing"
          hs.message = ""
          if obj.status ~= nil then
            if obj.status.health ~= nil then
              hs.status = obj.status.health.status
              if obj.status.health.message ~= nil then
                hs.message = obj.status.health.message
              end
            end
          end
          return hs

  # RBAC configuration
  rbacConfig:
    policy.default: role:readonly
    policy.csv: |
      # Default policies
      p, role:readonly, applications, get, */*, allow
      p, role:readonly, projects, get, *, allow

      # Admin role
      g, admin, role:admin

  # Admin password (from secret)
  extraArgs:
    - --insecure  # TLS termination at Gateway

# Repo Server (Git repository interaction)
repoServer:
  replicas: 2  # HA

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5

  metrics:
    enabled: true
    serviceMonitor:
      enabled: false

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 1Gi

  # KSOPS Plugin Configuration for SOPS secret decryption
  initContainers:
    - name: install-ksops
      image: viaductoss/ksops:v4.3.1
      command: ["/bin/sh", "-c"]
      args:
        - echo "Installing KSOPS...";
          cp ksops /custom-tools/;
          cp $GOPATH/bin/kustomize /custom-tools/;
          echo "KSOPS installed successfully"
      volumeMounts:
        - mountPath: /custom-tools
          name: custom-tools

  volumeMounts:
    - mountPath: /usr/local/bin/ksops
      name: custom-tools
      subPath: ksops
    - mountPath: /usr/local/bin/kustomize
      name: custom-tools
      subPath: kustomize
    - mountPath: /.config/sops/age
      name: sops-age-key

  volumes:
    - name: custom-tools
      emptyDir: {}
    - name: sops-age-key
      secret:
        secretName: sops-age-key

  env:
    - name: XDG_CONFIG_HOME
      value: /.config
    - name: KUSTOMIZE_PLUGIN_HOME
      value: /usr/local/bin/kustomize/plugin

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: repo-server
            topologyKey: kubernetes.io/hostname

# ApplicationSet Controller (App-of-Apps)
applicationSet:
  enabled: true
  replicas: 2

  metrics:
    enabled: true
    serviceMonitor:
      enabled: false

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Notifications Controller
notifications:
  enabled: true

  argocdUrl: https://argocd.example.com

  notifiers:
    # Slack notifications
    service.slack: |
      token: $slack-token

    # Email notifications
    service.email: |
      host: smtp.gmail.com
      port: 587
      from: argocd@example.com

  templates:
    template.app-deployed: |
      message: |
        Application {{.app.metadata.name}} deployed to {{.app.spec.destination.namespace}}
      slack:
        attachments: |
          [{
            "title": "{{.app.metadata.name}}",
            "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
            "color": "#18be52",
            "fields": [{
              "title": "Sync Status",
              "value": "{{.app.status.sync.status}}",
              "short": true
            }, {
              "title": "Repository",
              "value": "{{.app.spec.source.repoURL}}",
              "short": true
            }]
          }]

    template.app-sync-failed: |
      message: |
        Application {{.app.metadata.name}} sync failed
      slack:
        attachments: |
          [{
            "title": "{{.app.metadata.name}}",
            "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
            "color": "#ff0000",
            "fields": [{
              "title": "Sync Status",
              "value": "{{.app.status.sync.status}}",
              "short": true
            }]
          }]

  triggers:
    trigger.on-deployed: |
      - when: app.status.sync.status == 'Synced'
        send: [app-deployed]

    trigger.on-sync-failed: |
      - when: app.status.sync.status == 'Failed'
        send: [app-sync-failed]

# Dex (SSO/OAuth - optional)
dex:
  enabled: false  # Enable for SSO integration

# Configs
configs:
  secret:
    createSecret: true
    # argocdServerAdminPassword: ""  # Set via External Secrets

  # Known hosts for Git SSH
  ssh:
    knownHosts: |
      github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==

# Redis (cache)
redis:
  enabled: true

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Installation instructions:
# helm repo add argo https://argoproj.github.io/argo-helm
# helm install argocd argo/argo-cd -n argocd --create-namespace -f helm-values.yaml
