# ApplicationSet: Auto-Discover All Client/Environment Configurations
#
# This ApplicationSet automatically discovers all client/environment configurations
# by scanning YAML files in the values/deployments/ directory.
#
# How it works:
# 1. Scans values/deployments/*.yaml files (excluding example-*.yaml)
# 2. For each file found (e.g., values/deployments/clienta-prod.yaml):
#    - Creates a root Application named "clienta-prod-root"
#    - Deploys to namespace "clienta-prod"
#    - Uses values from that YAML file
# 3. Each root Application deploys the full stack (infrastructure + applications)
#
# True GitOps Workflow:
# - Add new client: Create values/deployments/newclient-prod.yaml → git push
# - Update client: Edit values/deployments/clienta-prod.yaml → git push
# - ArgoCD automatically detects changes and syncs
#
# This is deployed ONCE during cluster bootstrap. After that, everything is Git-driven.

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: monobase-auto-discover
  namespace: argocd
spec:
  # Enable Go template support for string manipulation
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  # Prevent cascading deletes (safety)
  syncPolicy:
    preserveResourcesOnDeletion: true

  generators:
    # Git Files Generator: Scans values/deployments/*.yaml files
    - git:
        repoURL: https://github.com/mycurelabs/monobase-infra-philcare.git
        revision: eaaa14ecd946865a150f5f75a09a38bae83cbd4e  # Temporarily pinned to force cache refresh
        files:
          # Include: scan all YAML files in values/deployments/
          - path: "values/deployments/*.yaml"
          # Exclude: reference examples
          - path: "values/deployments/example-*.yaml"
            exclude: true

  # Template for creating root Applications
  template:
    metadata:
      # Application name: {filename-without-extension}-root
      # e.g., "clienta-prod-root", "clientb-staging-root"
      name: '{{.path.filename | trimSuffix ".yaml"}}-root'
      namespace: argocd
      labels:
        client-env: '{{.path.filename | trimSuffix ".yaml"}}'
        managed-by: applicationset
      annotations:
        # Link back to config file
        config-path: '{{.path.path}}/{{.path.filename}}'
      finalizers:
        - resources-finalizer.argocd.argoproj.io

    spec:
      project: default

      source:
        # Point to this Git repository
        repoURL: https://github.com/mycurelabs/monobase-infra-philcare.git
        targetRevision: eaaa14ecd946865a150f5f75a09a38bae83cbd4e  # Temporarily pinned to force cache refresh
        path: argocd/applications

        # Use Helm to render application templates
        helm:
          # Value file is the discovered file itself
          # e.g., values/deployments/clienta-prod.yaml
          valueFiles:
            - '../../{{.path.path}}/{{.path.filename}}'
          # Inject repoURL from bootstrap (single source of truth)
          values: |
            argocd:
              repoURL: https://github.com/mycurelabs/monobase-infra-philcare.git
              targetRevision: eaaa14ecd946865a150f5f75a09a38bae83cbd4e

      destination:
        # Deploy to the same cluster
        server: https://kubernetes.default.svc
        # Namespace matches filename (without extension)
        # e.g., clienta-prod.yaml → clienta-prod namespace
        namespace: '{{.path.filename | trimSuffix ".yaml"}}'

      syncPolicy:
        # Automated sync: Git push → automatic deployment
        automated:
          prune: true        # Remove resources deleted from Git
          selfHeal: true     # Revert manual changes
          allowEmpty: false  # Prevent accidental empty deploys

        syncOptions:
          - CreateNamespace=true              # Auto-create namespace if missing
          - PrunePropagationPolicy=foreground # Delete in correct order
          - PruneLast=true                    # Prune after new resources are healthy

        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m

      # Ignore differences that are expected
      ignoreDifferences:
        # Ignore Helm managed fields
        - group: "*"
          kind: "*"
          jsonPointers:
            - /metadata/annotations/meta.helm.sh~1release-name
            - /metadata/annotations/meta.helm.sh~1release-namespace

# Usage:
#
# Deploy this ApplicationSet ONCE during cluster bootstrap:
#   kubectl apply -f argocd/bootstrap/applicationset-auto-discover.yaml
#
# After that, just manage deployments via Git:
#
# Add new client:
#   cp values/deployments/example-prod.yaml values/deployments/newclient-prod.yaml
#   # Edit values/deployments/newclient-prod.yaml
#   git add values/deployments/newclient-prod.yaml
#   git commit -m "Add newclient-prod"
#   git push
#   # ✓ ArgoCD auto-detects and deploys!
#
# Update existing client:
#   vim values/deployments/clienta-prod.yaml
#   git commit -m "Update clienta-prod: increase replicas"
#   git push
#   # ✓ ArgoCD auto-syncs only clienta-prod
#
# Remove client:
#   git rm values/deployments/oldclient-prod.yaml
#   git commit -m "Remove oldclient-prod"
#   git push
#   # ✓ ArgoCD auto-removes the Application (preserveResourcesOnDeletion=true prevents data loss)
