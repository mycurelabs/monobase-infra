# Allow Applications to Access Database
# Permits API to connect to PostgreSQL

---
# Allow API → PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-to-postgresql
  namespace: {{ .Values.global.namespace }}
  labels:
    security-policy: allow-egress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: postgresql

  policyTypes:
    - Ingress

  ingress:
    # Allow from API
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: api
      ports:
        - protocol: TCP
          port: 5432

---
# Egress from API to PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-egress-to-postgresql
  namespace: {{ .Values.global.namespace }}
  labels:
    security-policy: allow-egress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: api

  policyTypes:
    - Egress

  egress:
    # To PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgresql
      ports:
        - protocol: TCP
          port: 5432

    # To DNS (required for service discovery)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # To Kubernetes API (for service discovery)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
# Allow HapiHub/SyncD → MongoDB (ingress to in-cluster MongoDB)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-hapihub-to-mongodb
  namespace: {{ .Values.global.namespace }}
  labels:
    security-policy: allow-egress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: mongodb

  policyTypes:
    - Ingress

  ingress:
    # Allow from HapiHub
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: hapihub
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: syncd
      ports:
        - protocol: TCP
          port: 27017

---
# Egress from HapiHub to MongoDB (in-cluster or managed)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-hapihub-egress-to-mongodb
  namespace: {{ .Values.global.namespace }}
  labels:
    security-policy: allow-egress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: hapihub

  policyTypes:
    - Egress

  egress:
    # To in-cluster MongoDB (if enabled)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: mongodb
      ports:
        - protocol: TCP
          port: 27017

    # To external/managed MongoDB (DigitalOcean, Atlas, etc.)
    # No 'to' selector = allows all destinations on MongoDB port
    - ports:
        - protocol: TCP
          port: 27017

    # To DNS (required for service discovery)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # To External HTTPS Services (OAuth, APIs, etc.)
    # No 'to' selector = allows all destinations
    - ports:
        - protocol: TCP
          port: 443

---
# Egress from SyncD to MongoDB (in-cluster or managed)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-syncd-egress-to-mongodb
  namespace: {{ .Values.global.namespace }}
  labels:
    security-policy: allow-egress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: syncd

  policyTypes:
    - Egress

  egress:
    # To in-cluster MongoDB (if enabled)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: mongodb
      ports:
        - protocol: TCP
          port: 27017

    # To external/managed MongoDB (DigitalOcean, Atlas, etc.)
    # No 'to' selector = allows all destinations on MongoDB port
    - ports:
        - protocol: TCP
          port: 27017

    # To DNS (required for service discovery)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# Egress from DentaLemon Website to External APIs
# Required for Next.js middleware to proxy API requests to HapiHub
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dentalemon-website-egress-https
  namespace: {{ .Values.global.namespace }}
  labels:
    security-policy: allow-egress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: dentalemon-website

  policyTypes:
    - Egress

  egress:
    # To DNS (required for service discovery)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # To External HTTPS Services (HapiHub API)
    # No 'to' selector = allows all destinations
    - ports:
        - protocol: TCP
          port: 443

---
# Notes:
# 1. Only API backend can access PostgreSQL
# 2. Only HapiHub and SyncD backends can access MongoDB
# 3. Account and MyCure (frontends) have NO database access (security!)
# 4. DNS access required for service name resolution
# 5. Kubernetes API access needed for service discovery
# 6. DentaLemon Website needs HTTPS egress for Next.js middleware API proxy
