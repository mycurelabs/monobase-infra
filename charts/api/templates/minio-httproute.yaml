{{- if and .Values.enabled .Values.minio.enabled .Values.gateway.enabled }}
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ include "api.fullname" . }}-minio
  namespace: {{ include "api.namespace" . }}
  labels:
    {{- include "api.labels" . | nindent 4 }}
    app.kubernetes.io/component: minio
spec:
  parentRefs:
    - name: {{ include "api.gateway.name" . }}
      namespace: {{ include "api.gateway.namespace" . }}
  hostnames:
    - {{ if .Values.minio.gateway }}{{ .Values.minio.gateway.hostname | default (printf "storage.%s" .Values.global.domain) }}{{ else }}{{ printf "storage.%s" .Values.global.domain }}{{ end }}
  rules:
    # S3 API and MinIO Console
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: {{ .Release.Name }}-minio
          port: 9000
          weight: 1
      
      # Rate limiting for public file access
      filters:
        - type: ExtensionRef
          extensionRef:
            group: gateway.envoyproxy.io
            kind: BackendTrafficPolicy
            name: minio-rate-limit

---
# BackendTrafficPolicy for MinIO Rate Limiting
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: BackendTrafficPolicy
metadata:
  name: minio-rate-limit
  namespace: {{ include "api.namespace" . }}
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: {{ include "api.fullname" . }}-minio
  
  rateLimit:
    type: Global
    global:
      rules:
        # Per-IP download rate limit
        - limit:
            requests: 100
            unit: Second
          clientSelectors:
            - headers:
                - name: X-Forwarded-For
                  type: Distinct
        
        # Burst limit
        - limit:
            requests: 1000
            unit: Minute
          clientSelectors:
            - headers:
                - name: X-Forwarded-For
                  type: Distinct
{{- end }}
